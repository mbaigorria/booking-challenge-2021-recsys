<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>recsys.utils API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-190294593-1', 'auto'); ga('send', 'pageview');
</script><script async src='https://www.google-analytics.com/analytics.js'></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>recsys.utils</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L0-L232" class="git-link">Browse git</a>
</summary>
<pre><code class="python">import functools
import gc
import json
import logging
import os
import subprocess
import sys
from datetime import datetime
from os import listdir
from os.path import isfile
from typing import List, Dict

import GPUtil as GPU
import humanize
import pandas as pd
import psutil
import torch
from torch.utils.data import DataLoader

if &#39;ipykernel&#39; in sys.modules:
    from tqdm.notebook import tqdm
else:
    from tqdm import tqdm

from recsys.dataset_loader import BookingDataset, get_dataset_and_dataloader
from recsys.encoders import DatasetEncoder
from recsys.model import get_model_predictions, BookingNet
from recsys.paths import get_resources_path, get_path, get_model_ckpt_paths, get_model_arch_path
from recsys import config


def print_gpu_usage(gpu_id: int = 0):
    &#34;&#34;&#34;
    Display GPU usage.
    &#34;&#34;&#34;
    gpu_list = GPU.getGPUs()
    gpu = gpu_list[gpu_id]
    process = psutil.Process(os.getpid())
    logging.info(f&#34;Gen RAM Free: {humanize.naturalsize(psutil.virtual_memory().available)}&#34;
                 f&#34; | Proc size: {humanize.naturalsize(process.memory_info().rss)}&#34;)
    logging.info(&#34;GPU RAM Free: {0:.0f}MB | Used: {1:.0f}MB | Util {2:3.0f}% | Total {3:.0f}MB&#34;.format(gpu.memoryFree,
                                                                                                       gpu.memoryUsed,
                                                                                                       gpu.memoryUtil * 100,
                                                                                                       gpu.memoryTotal))


def accuracy_at_k(submission: pd.DataFrame,
                  ground_truth: pd.DataFrame) -&gt; Dict:
    &#34;&#34;&#34;
    Calculates accuracy@k for k in {1, 4, 10} by group length and overall.
    &#34;&#34;&#34;
    data_to_eval = submission.join(ground_truth, on=&#39;utrip_id&#39;)

    for k in [1, 4, 10]:
        data_to_eval[f&#39;hits_at_{k}&#39;] = data_to_eval.apply(
            lambda row: row[&#39;city_id&#39;] in row[[f&#39;city_id_{i}&#39; for i in range(1, k + 1)]].values, axis=1)
    return {
        &#39;accuracy@1&#39;: data_to_eval[&#39;hits_at_1&#39;].mean(),
        &#39;accuracy@4&#39;: data_to_eval[&#39;hits_at_4&#39;].mean(),
        &#39;accuracy@10&#39;: data_to_eval[&#39;hits_at_10&#39;].mean(),
        &#39;accuracy@4_by_pos&#39;: data_to_eval.groupby(&#39;group_length&#39;)[&#39;hits_at_4&#39;].mean().to_dict()
    }


def get_submission(dataset: BookingDataset,
                   data_loader: DataLoader,
                   model: BookingNet,
                   checkpoint_path_list: List[str],
                   dataset_encoder: DatasetEncoder) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get submission from dataset.
    &#34;&#34;&#34;
    assert len(checkpoint_path_list) &gt; 0

    ensemble_batch_probs = None
    for checkpoint_path in tqdm(checkpoint_path_list):
        batch_probs_generator = get_model_predictions(model,
                                                      data_loader,
                                                      checkpoint_path)
        if ensemble_batch_probs is None:
            ensemble_batch_probs = list(batch_probs_generator)
        else:
            for i, batch_probs in enumerate(batch_probs_generator):
                ensemble_batch_probs[i] += batch_probs

    top_cities = torch.cat(
        [torch.topk(batch_submission, 10, dim=1).indices + 1
         for batch_submission in ensemble_batch_probs],
        axis=0
    )
    del ensemble_batch_probs
    cities_prediction = pd.DataFrame(top_cities.numpy(),
                                     columns=[f&#39;city_id_{i}&#39; for i in range(1, 11)])
    del top_cities
    gc.collect()

    for city_id in range(1, 11):
        cities_prediction[f&#39;city_id_{city_id}&#39;] = dataset_encoder.label_encoders[&#39;city_id&#39;].inverse_transform(
            cities_prediction[f&#39;city_id_{city_id}&#39;] - 1).astype(int)

    submission = pd.concat([dataset.get_ids(), cities_prediction], axis=1)
    return submission


def get_ground_truth_from_dataset(df: pd.DataFrame,
                                  booking_dataset: BookingDataset,
                                  dataset_encoder: DatasetEncoder) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get ground truth from dataset. Assumes the df is sorted by checkin ASC.
    &#34;&#34;&#34;
    ground_truth = df.groupby(&#39;utrip_id&#39;).tail(1)[[&#39;utrip_id&#39;, &#39;next_city_id&#39;]].set_index(&#39;utrip_id&#39;)
    ground_truth[&#39;city_id&#39;] = (dataset_encoder
                               .label_encoders[&#39;city_id&#39;]
                               .inverse_transform(ground_truth[&#39;next_city_id&#39;] - 1))
    if not ground_truth[&#39;city_id&#39;].isnull().values.any():
        ground_truth[&#39;city_id&#39;] = ground_truth[&#39;city_id&#39;].astype(int)
    else:
        logging.warning(&#34;Warning: next_city_id has nulls&#34;)

    ground_truth = ground_truth.loc[booking_dataset.utrip_ids]  # reorder obs like batches
    ground_truth.drop(columns=&#34;next_city_id&#34;, inplace=True)
    return ground_truth


def get_count_distribution(df: pd.DataFrame,
                           by: str = &#39;utrip_id&#39;) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get count distribution from dataset.
    &#34;&#34;&#34;
    df_dist = df.groupby(by)[by].count().value_counts(sort=True)
    df_dist /= df_dist.sum()
    return df_dist


def get_distribution_by_pos(**kwargs) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get distribution by pos from a list of key: dataframe pairs.
    &#34;&#34;&#34;
    return functools.reduce(lambda a, b: a.join(b),
                            [get_count_distribution(df).to_frame(name)
                             for name, df in kwargs.items()]).sort_index()


def check_device() -&gt; None:
    &#34;&#34;&#34;
    Check if we are using GPU acceleration and warn the user.
    &#34;&#34;&#34;
    if config.DEVICE != &#39;cuda&#39;:
        logging.warning(&#39;You are not using a GPU. If you are using colab, go to Runtime -&gt; Change runtime type&#39;)
    else:
        current_gpu = subprocess.check_output([&#39;nvidia-smi&#39;, &#39;-L&#39;]).strip().decode(&#39;ascii&#39;)
        logging.info(f&#34;Using {current_gpu}&#34;)


def get_trained_models() -&gt; Dict:
    &#34;&#34;&#34;
    Get dictionary of all models trained
    &#34;&#34;&#34;
    base_path = get_path(&#34;architectures&#34;)
    model_paths = [f&#34;{base_path}/{f}&#34; for f in listdir(base_path) if isfile(f&#34;{base_path}/{f}&#34;)]

    d = {}

    for path in model_paths:
        with open(path) as f:
            model_hash = path[-13:-5]
            d[model_hash] = json.load(f)
    return d


def get_final_submission(submission_set: pd.DataFrame,
                         model_hash: str,
                         dataset_encoder: DatasetEncoder) -&gt; None:
    &#34;&#34;&#34;
    Get final submission from model hash.
    &#34;&#34;&#34;
    # create final submission
    dataset_submission, data_loader_submission = get_dataset_and_dataloader(
        df=submission_set,
        features=config.FEATURES_EMBEDDING
    )

    # get model parameters from hash
    with open(get_model_arch_path(model_hash)) as fhandle:
        model_parameters = json.load(fhandle)
    ckpt_list = get_model_ckpt_paths(model_hash=model_hash,
                                     checkpoint_type=&#39;accuracy_at_k&#39;)

    # load model and get predictions
    model = BookingNet(**model_parameters).to(config.DEVICE)
    predictions = get_submission(dataset_submission,
                                 data_loader_submission,
                                 model,
                                 ckpt_list,
                                 dataset_encoder)

    # build final csv and run sanity checks
    timestamp = datetime.now().strftime(&#34;%d_%m_%Y_%Hh_%Mm_%Ss&#34;)
    cols = [&#34;utrip_id&#34;, &#34;city_id_1&#34;, &#34;city_id_2&#34;, &#34;city_id_3&#34;, &#34;city_id_4&#34;]
    filename = f&#39;submission_{model_hash}_{timestamp}&#39;
    final_submission = predictions[cols]
    final_submission.to_csv(get_path(dirs=&#34;submissions&#34;,
                                     filename=filename,
                                     format=&#39;csv&#39;),
                            index=False)
    submission_sanity_checks(final_submission)


def submission_sanity_checks(submission: pd.DataFrame) -&gt; None:
    &#34;&#34;&#34;
    Run submission sanity checks to make sure our dataframe is healthy.
    &#34;&#34;&#34;
    _TOTAL_SUBMISSION_ROWS = 70662
    df = pd.read_csv(get_resources_path(&#39;booking_test_set.csv&#39;),
                     dtype={&#39;user_id&#39;: &#39;int32&#39;, &#39;city_id&#39;: &#39;int32&#39;},
                     parse_dates=[&#39;checkin&#39;, &#39;checkout&#39;])

    utrip_ids = set(df.utrip_id.unique())
    assert len(set(submission.utrip_id.unique()).intersection(utrip_ids)) == _TOTAL_SUBMISSION_ROWS
    assert submission.shape == (_TOTAL_SUBMISSION_ROWS, 5)
    assert submission.notna().values.all()

    df = pd.read_csv(get_resources_path(&#39;booking_train_set.csv&#39;),
                     dtype={&#39;user_id&#39;: &#39;int32&#39;, &#39;city_id&#39;: &#39;int32&#39;},
                     parse_dates=[&#39;checkin&#39;, &#39;checkout&#39;])

    # verify city ids
    city_ids = set(df.city_id.unique().astype(int))
    assert len(set(submission.city_id_1.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_2.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_3.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_4.unique()).difference(city_ids)) == 0
    logging.info(&#34;Passed all sanity checks!&#34;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="recsys.utils.accuracy_at_k"><code class="name flex">
<span>def <span class="ident">accuracy_at_k</span></span>(<span>submission: pandas.core.frame.DataFrame, ground_truth: pandas.core.frame.DataFrame) ‑> Dict</span>
</code></dt>
<dd>
<div class="desc"><p>Calculates accuracy@k for k in {1, 4, 10} by group length and overall.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L47-L62" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def accuracy_at_k(submission: pd.DataFrame,
                  ground_truth: pd.DataFrame) -&gt; Dict:
    &#34;&#34;&#34;
    Calculates accuracy@k for k in {1, 4, 10} by group length and overall.
    &#34;&#34;&#34;
    data_to_eval = submission.join(ground_truth, on=&#39;utrip_id&#39;)

    for k in [1, 4, 10]:
        data_to_eval[f&#39;hits_at_{k}&#39;] = data_to_eval.apply(
            lambda row: row[&#39;city_id&#39;] in row[[f&#39;city_id_{i}&#39; for i in range(1, k + 1)]].values, axis=1)
    return {
        &#39;accuracy@1&#39;: data_to_eval[&#39;hits_at_1&#39;].mean(),
        &#39;accuracy@4&#39;: data_to_eval[&#39;hits_at_4&#39;].mean(),
        &#39;accuracy@10&#39;: data_to_eval[&#39;hits_at_10&#39;].mean(),
        &#39;accuracy@4_by_pos&#39;: data_to_eval.groupby(&#39;group_length&#39;)[&#39;hits_at_4&#39;].mean().to_dict()
    }</code></pre>
</details>
</dd>
<dt id="recsys.utils.check_device"><code class="name flex">
<span>def <span class="ident">check_device</span></span>(<span>) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Check if we are using GPU acceleration and warn the user.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L144-L152" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def check_device() -&gt; None:
    &#34;&#34;&#34;
    Check if we are using GPU acceleration and warn the user.
    &#34;&#34;&#34;
    if config.DEVICE != &#39;cuda&#39;:
        logging.warning(&#39;You are not using a GPU. If you are using colab, go to Runtime -&gt; Change runtime type&#39;)
    else:
        current_gpu = subprocess.check_output([&#39;nvidia-smi&#39;, &#39;-L&#39;]).strip().decode(&#39;ascii&#39;)
        logging.info(f&#34;Using {current_gpu}&#34;)</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_count_distribution"><code class="name flex">
<span>def <span class="ident">get_count_distribution</span></span>(<span>df: pandas.core.frame.DataFrame, by: str = 'utrip_id') ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Get count distribution from dataset.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L125-L132" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_count_distribution(df: pd.DataFrame,
                           by: str = &#39;utrip_id&#39;) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get count distribution from dataset.
    &#34;&#34;&#34;
    df_dist = df.groupby(by)[by].count().value_counts(sort=True)
    df_dist /= df_dist.sum()
    return df_dist</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_distribution_by_pos"><code class="name flex">
<span>def <span class="ident">get_distribution_by_pos</span></span>(<span>**kwargs) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Get distribution by pos from a list of key: dataframe pairs.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L135-L141" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_distribution_by_pos(**kwargs) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get distribution by pos from a list of key: dataframe pairs.
    &#34;&#34;&#34;
    return functools.reduce(lambda a, b: a.join(b),
                            [get_count_distribution(df).to_frame(name)
                             for name, df in kwargs.items()]).sort_index()</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_final_submission"><code class="name flex">
<span>def <span class="ident">get_final_submission</span></span>(<span>submission_set: pandas.core.frame.DataFrame, model_hash: str, dataset_encoder: <a title="recsys.encoders.DatasetEncoder" href="encoders.html#recsys.encoders.DatasetEncoder">DatasetEncoder</a>) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Get final submission from model hash.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L171-L206" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_final_submission(submission_set: pd.DataFrame,
                         model_hash: str,
                         dataset_encoder: DatasetEncoder) -&gt; None:
    &#34;&#34;&#34;
    Get final submission from model hash.
    &#34;&#34;&#34;
    # create final submission
    dataset_submission, data_loader_submission = get_dataset_and_dataloader(
        df=submission_set,
        features=config.FEATURES_EMBEDDING
    )

    # get model parameters from hash
    with open(get_model_arch_path(model_hash)) as fhandle:
        model_parameters = json.load(fhandle)
    ckpt_list = get_model_ckpt_paths(model_hash=model_hash,
                                     checkpoint_type=&#39;accuracy_at_k&#39;)

    # load model and get predictions
    model = BookingNet(**model_parameters).to(config.DEVICE)
    predictions = get_submission(dataset_submission,
                                 data_loader_submission,
                                 model,
                                 ckpt_list,
                                 dataset_encoder)

    # build final csv and run sanity checks
    timestamp = datetime.now().strftime(&#34;%d_%m_%Y_%Hh_%Mm_%Ss&#34;)
    cols = [&#34;utrip_id&#34;, &#34;city_id_1&#34;, &#34;city_id_2&#34;, &#34;city_id_3&#34;, &#34;city_id_4&#34;]
    filename = f&#39;submission_{model_hash}_{timestamp}&#39;
    final_submission = predictions[cols]
    final_submission.to_csv(get_path(dirs=&#34;submissions&#34;,
                                     filename=filename,
                                     format=&#39;csv&#39;),
                            index=False)
    submission_sanity_checks(final_submission)</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_ground_truth_from_dataset"><code class="name flex">
<span>def <span class="ident">get_ground_truth_from_dataset</span></span>(<span>df: pandas.core.frame.DataFrame, booking_dataset: <a title="recsys.dataset_loader.BookingDataset" href="dataset_loader.html#recsys.dataset_loader.BookingDataset">BookingDataset</a>, dataset_encoder: <a title="recsys.encoders.DatasetEncoder" href="encoders.html#recsys.encoders.DatasetEncoder">DatasetEncoder</a>) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Get ground truth from dataset. Assumes the df is sorted by checkin ASC.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L105-L122" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_ground_truth_from_dataset(df: pd.DataFrame,
                                  booking_dataset: BookingDataset,
                                  dataset_encoder: DatasetEncoder) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get ground truth from dataset. Assumes the df is sorted by checkin ASC.
    &#34;&#34;&#34;
    ground_truth = df.groupby(&#39;utrip_id&#39;).tail(1)[[&#39;utrip_id&#39;, &#39;next_city_id&#39;]].set_index(&#39;utrip_id&#39;)
    ground_truth[&#39;city_id&#39;] = (dataset_encoder
                               .label_encoders[&#39;city_id&#39;]
                               .inverse_transform(ground_truth[&#39;next_city_id&#39;] - 1))
    if not ground_truth[&#39;city_id&#39;].isnull().values.any():
        ground_truth[&#39;city_id&#39;] = ground_truth[&#39;city_id&#39;].astype(int)
    else:
        logging.warning(&#34;Warning: next_city_id has nulls&#34;)

    ground_truth = ground_truth.loc[booking_dataset.utrip_ids]  # reorder obs like batches
    ground_truth.drop(columns=&#34;next_city_id&#34;, inplace=True)
    return ground_truth</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_submission"><code class="name flex">
<span>def <span class="ident">get_submission</span></span>(<span>dataset: <a title="recsys.dataset_loader.BookingDataset" href="dataset_loader.html#recsys.dataset_loader.BookingDataset">BookingDataset</a>, data_loader: torch.utils.data.dataloader.DataLoader, model: <a title="recsys.model.BookingNet" href="model.html#recsys.model.BookingNet">BookingNet</a>, checkpoint_path_list: List[str], dataset_encoder: <a title="recsys.encoders.DatasetEncoder" href="encoders.html#recsys.encoders.DatasetEncoder">DatasetEncoder</a>) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Get submission from dataset.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L65-L102" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_submission(dataset: BookingDataset,
                   data_loader: DataLoader,
                   model: BookingNet,
                   checkpoint_path_list: List[str],
                   dataset_encoder: DatasetEncoder) -&gt; pd.DataFrame:
    &#34;&#34;&#34;
    Get submission from dataset.
    &#34;&#34;&#34;
    assert len(checkpoint_path_list) &gt; 0

    ensemble_batch_probs = None
    for checkpoint_path in tqdm(checkpoint_path_list):
        batch_probs_generator = get_model_predictions(model,
                                                      data_loader,
                                                      checkpoint_path)
        if ensemble_batch_probs is None:
            ensemble_batch_probs = list(batch_probs_generator)
        else:
            for i, batch_probs in enumerate(batch_probs_generator):
                ensemble_batch_probs[i] += batch_probs

    top_cities = torch.cat(
        [torch.topk(batch_submission, 10, dim=1).indices + 1
         for batch_submission in ensemble_batch_probs],
        axis=0
    )
    del ensemble_batch_probs
    cities_prediction = pd.DataFrame(top_cities.numpy(),
                                     columns=[f&#39;city_id_{i}&#39; for i in range(1, 11)])
    del top_cities
    gc.collect()

    for city_id in range(1, 11):
        cities_prediction[f&#39;city_id_{city_id}&#39;] = dataset_encoder.label_encoders[&#39;city_id&#39;].inverse_transform(
            cities_prediction[f&#39;city_id_{city_id}&#39;] - 1).astype(int)

    submission = pd.concat([dataset.get_ids(), cities_prediction], axis=1)
    return submission</code></pre>
</details>
</dd>
<dt id="recsys.utils.get_trained_models"><code class="name flex">
<span>def <span class="ident">get_trained_models</span></span>(<span>) ‑> Dict</span>
</code></dt>
<dd>
<div class="desc"><p>Get dictionary of all models trained</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L155-L168" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def get_trained_models() -&gt; Dict:
    &#34;&#34;&#34;
    Get dictionary of all models trained
    &#34;&#34;&#34;
    base_path = get_path(&#34;architectures&#34;)
    model_paths = [f&#34;{base_path}/{f}&#34; for f in listdir(base_path) if isfile(f&#34;{base_path}/{f}&#34;)]

    d = {}

    for path in model_paths:
        with open(path) as f:
            model_hash = path[-13:-5]
            d[model_hash] = json.load(f)
    return d</code></pre>
</details>
</dd>
<dt id="recsys.utils.print_gpu_usage"><code class="name flex">
<span>def <span class="ident">print_gpu_usage</span></span>(<span>gpu_id: int = 0)</span>
</code></dt>
<dd>
<div class="desc"><p>Display GPU usage.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L32-L44" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def print_gpu_usage(gpu_id: int = 0):
    &#34;&#34;&#34;
    Display GPU usage.
    &#34;&#34;&#34;
    gpu_list = GPU.getGPUs()
    gpu = gpu_list[gpu_id]
    process = psutil.Process(os.getpid())
    logging.info(f&#34;Gen RAM Free: {humanize.naturalsize(psutil.virtual_memory().available)}&#34;
                 f&#34; | Proc size: {humanize.naturalsize(process.memory_info().rss)}&#34;)
    logging.info(&#34;GPU RAM Free: {0:.0f}MB | Used: {1:.0f}MB | Util {2:3.0f}% | Total {3:.0f}MB&#34;.format(gpu.memoryFree,
                                                                                                       gpu.memoryUsed,
                                                                                                       gpu.memoryUtil * 100,
                                                                                                       gpu.memoryTotal))</code></pre>
</details>
</dd>
<dt id="recsys.utils.submission_sanity_checks"><code class="name flex">
<span>def <span class="ident">submission_sanity_checks</span></span>(<span>submission: pandas.core.frame.DataFrame) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>Run submission sanity checks to make sure our dataframe is healthy.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/mbaigorria/booking-challenge-2021-recsys/blob/72d9382485ebfd6da4c12d4da628e072acc8a9bf/recsys/utils.py#L209-L233" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def submission_sanity_checks(submission: pd.DataFrame) -&gt; None:
    &#34;&#34;&#34;
    Run submission sanity checks to make sure our dataframe is healthy.
    &#34;&#34;&#34;
    _TOTAL_SUBMISSION_ROWS = 70662
    df = pd.read_csv(get_resources_path(&#39;booking_test_set.csv&#39;),
                     dtype={&#39;user_id&#39;: &#39;int32&#39;, &#39;city_id&#39;: &#39;int32&#39;},
                     parse_dates=[&#39;checkin&#39;, &#39;checkout&#39;])

    utrip_ids = set(df.utrip_id.unique())
    assert len(set(submission.utrip_id.unique()).intersection(utrip_ids)) == _TOTAL_SUBMISSION_ROWS
    assert submission.shape == (_TOTAL_SUBMISSION_ROWS, 5)
    assert submission.notna().values.all()

    df = pd.read_csv(get_resources_path(&#39;booking_train_set.csv&#39;),
                     dtype={&#39;user_id&#39;: &#39;int32&#39;, &#39;city_id&#39;: &#39;int32&#39;},
                     parse_dates=[&#39;checkin&#39;, &#39;checkout&#39;])

    # verify city ids
    city_ids = set(df.city_id.unique().astype(int))
    assert len(set(submission.city_id_1.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_2.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_3.unique()).difference(city_ids)) == 0
    assert len(set(submission.city_id_4.unique()).difference(city_ids)) == 0
    logging.info(&#34;Passed all sanity checks!&#34;)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="recsys" href="index.html">recsys</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="recsys.utils.accuracy_at_k" href="#recsys.utils.accuracy_at_k">accuracy_at_k</a></code></li>
<li><code><a title="recsys.utils.check_device" href="#recsys.utils.check_device">check_device</a></code></li>
<li><code><a title="recsys.utils.get_count_distribution" href="#recsys.utils.get_count_distribution">get_count_distribution</a></code></li>
<li><code><a title="recsys.utils.get_distribution_by_pos" href="#recsys.utils.get_distribution_by_pos">get_distribution_by_pos</a></code></li>
<li><code><a title="recsys.utils.get_final_submission" href="#recsys.utils.get_final_submission">get_final_submission</a></code></li>
<li><code><a title="recsys.utils.get_ground_truth_from_dataset" href="#recsys.utils.get_ground_truth_from_dataset">get_ground_truth_from_dataset</a></code></li>
<li><code><a title="recsys.utils.get_submission" href="#recsys.utils.get_submission">get_submission</a></code></li>
<li><code><a title="recsys.utils.get_trained_models" href="#recsys.utils.get_trained_models">get_trained_models</a></code></li>
<li><code><a title="recsys.utils.print_gpu_usage" href="#recsys.utils.print_gpu_usage">print_gpu_usage</a></code></li>
<li><code><a title="recsys.utils.submission_sanity_checks" href="#recsys.utils.submission_sanity_checks">submission_sanity_checks</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>